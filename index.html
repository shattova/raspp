<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Расписание</title>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@100..900&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Montserrat', sans-serif;
            text-align: center;
            background-color: #f5f5f5;
            margin: 0;
            padding: 20px;
        }

        .container {
            max-width: 440px;
            margin: auto;
            background: white;
            padding: 20px 20px 0 20px;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0,0,0,.1);
        }

        .title_day {
            margin: 15px 0 15px 25px;
            font-size: 25px;
            font-weight: 700;
            text-align: left;
        }

        .schedule .day {
            padding: 9px;
            margin: 10px 0 30px;
            border-radius: 40px;
            background: linear-gradient(134deg,#ededed 0%,#ffffff 100%);
            box-shadow:
                -26px -26px 50px rgba(255,255,255,0.9),
                -26px 26px 50px rgba(216,216,216,0.2),
                26px -26px 50px rgba(216,216,216,0.2),
                26px 26px 50px rgba(216,216,216,0.9);
        }

        .circle {
            width: 20px;
            height: 20px;
            background: navy;
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 13px;
            font-weight: bold;
        }

        .circle2 {
            width: 20px;
            height: 20px;
            background: #1B5112;
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 13px;
            font-weight: bold;
        }

        .urok {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }

        body { font-family: 'Montserrat', sans-serif; background-color: #f5f5f5; margin: 0; padding: 20px; } .container { max-width: 440px; margin: auto; background: white; padding: 20px; border-radius: 10px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); } .welcome { font-size: 48px; text-align: center; margin-bottom: 20px; } .toggle-wrapper { display: flex; justify-content: center; margin-bottom: 20px; } .toggle-container { position: relative; width: 100%; height: 48px; border-radius: 100px; background: #fff; border: 2px solid #ddd; box-shadow: inset 4px 4px 9px rgba(0,0,0,0.25); cursor: pointer; } .toggle-checkbox { display: none; } .toggle-button { position: absolute; top: 7px; left: 8px; width: calc(50% - 16px); height: 32px; border-radius: 16px; background: linear-gradient(#2c2c7a, #0c0c3c); color: #fff; display: flex; align-items: center; justify-content: center; font-weight: bold; transition: 0.3s; } .toggle-checkbox:checked + .toggle-button { left: calc(50% + 8px); background: linear-gradient(#1c5c1c, #0c3c0c); } .toggle-button::after { content: "нечётная неделя"; } .toggle-checkbox:checked + .toggle-button::after { content: "чётная неделя"; } .day { margin-bottom: 30px; padding: 15px; border-radius: 30px; background: linear-gradient(134deg,#ededed,#fff); box-shadow: 0 10px 20px rgba(0,0,0,0.08); } .title_day { font-size: 24px; font-weight: 700; margin-bottom: 15px; } .urok { display: flex; margin-bottom: 10px; } .circle, .circle2 { width: 22px; height: 22px; border-radius: 50%; color: #fff; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: bold; flex-shrink: 0; } .circle { background: navy; } .circle2 { background: #1B5112; } .lesson { padding-left: 10px; } .name_urok { font-size: 12px; font-weight: 500; margin: 0; } .time_style { font-size: 10px; color: #757575; } #day2 { display: none; } .popup { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background: #0D0125; color: white; padding: 15px 20px; border-radius: 18px; display: none; z-index: 1000; }

        .empty-urok {
            height: 38px;
            margin-bottom: 10px;
            opacity: .25;
        }

        .time_style {
            color: #757575;
            font-size: 10px;
            margin-top: -2px;
        }

        .name_urok {
            font-size: 12px;
            margin: 0;
            font-weight: 500;
        }

        .remove-btn {
            margin-left: auto;
            cursor: pointer;
            color: #999;
        }

        .add-btn {
            width: 100%;
            margin-bottom: 20px;
            padding: 12px;
            border-radius: 14px;
            border: none;
            background: #0D0125;
            color: #fff;
            font-size: 14px;
            cursor: pointer;
        }

        .form {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,.4);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }

        .form-box {
            background: #fff;
            padding: 20px;
            border-radius: 20px;
            width: 300px;
        }

        .form-box input,
        .form-box select {
            width: 100%;
            margin-bottom: 10px;
            padding: 8px;
            border-radius: 10px;
            border: 1px solid #ddd;
        }

        .auth {
            position: fixed;
            inset: 0;
            background: rgba(245,245,245,.95);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 3000;
        }

        .auth-box {
            width: 320px;
            background: white;
            padding: 25px;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,.15);
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .auth-box button {
            padding: 10px;
            border-radius: 10px;
            border: none;
            background: linear-gradient(#2c2c7a,#0c0c3c);
            color: white;
            font-weight: bold;
            cursor: pointer;
        }

        .auth-box button.secondary {
            background: #eaeaea;
            color: #333;
        }

        #logoutBtn {
    position: fixed;
    bottom: 20px;
    left: 20px;
    width: 40px;
    height: 40px;
    border-radius: 50%;
    border: none;
    background: #aa0000;
    color: white;
    font-weight: bold;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 4000;
    font-size: 16px;
    box-shadow: 0 4px 8px rgba(0,0,0,0.3);
}

    </style>
</head>

<body>

<button id="logoutBtn" title="Выйти"></button>


<!-- AUTH -->
<div class="auth" id="auth">
    <div class="auth-box">
        <h2>Вход / регистрация</h2>
        <input id="email" type="email" placeholder="Email">
        <input id="password" type="password" placeholder="Пароль">
        <button onclick="signIn()">Войти</button>
        <button class="secondary" onclick="signUp()">Зарегистрироваться</button>
        <p id="auth-status"></p>
    </div>
</div>

<!-- SCHEDULE -->
<div class="container" id="schedule" style="display:none;">

    
    <div class="toggle-wrapper"> <label class="toggle-container"> <input type="checkbox" class="toggle-checkbox" id="toggleCheckbox"> <div class="toggle-button"></div> </label> </div>

    <button class="add-btn" onclick="openAddForm()">＋ добавить пару</button>

    <div id="day1">
        <div class="day" data-day="monday"><div class="title_day">понедельник</div></div>
        <div class="day" data-day="tuesday"><div class="title_day">вторник</div></div>
        <div class="day" data-day="wednesday"><div class="title_day">среда</div></div>
        <div class="day" data-day="thursday"><div class="title_day">четверг</div></div>
        <div class="day" data-day="friday"><div class="title_day">пятница</div></div>
    </div>

    <div id="day2" style="display:none;">
        <div class="day" data-day="monday"><div class="title_day">понедельник</div></div>
        <div class="day" data-day="tuesday"><div class="title_day">вторник</div></div>
        <div class="day" data-day="wednesday"><div class="title_day">среда</div></div>
        <div class="day" data-day="thursday"><div class="title_day">четверг</div></div>
        <div class="day" data-day="friday"><div class="title_day">пятница</div></div>
    </div>
</div>

<!-- FORM -->
<div class="form" id="form">
    <div class="form-box">
        <select id="daySelect">
            <option value="monday">Понедельник</option>
            <option value="tuesday">Вторник</option>
            <option value="wednesday">Среда</option>
            <option value="thursday">Четверг</option>
            <option value="friday">Пятница</option>
        </select>

        <select id="weekType">
            <option value="odd">Нечётная</option>
            <option value="even">Чётная</option>
            <option value="both">Обе</option>
        </select>

        <select id="lessonNumber">
            <option value="1">1 пара</option>
            <option value="2">2 пара</option>
            <option value="3">3 пара</option>
            <option value="4">4 пара</option>
            <option value="5">5 пара</option>
            <option value="6">6 пара</option>
        </select>

        <input id="name" placeholder="Название">
        <input id="teacher" placeholder="Преподаватель">
        <input id="room" placeholder="Аудитория">

        <button class="add-btn" onclick="addLesson()">Добавить</button>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
    const SUPABASE_URL = 'https://zncaxrvlcdkdhmhqrgdw.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpuY2F4cnZsY2RrZGhtaHFyZ2R3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk3MTY4NzQsImV4cCI6MjA4NTI5Mjg3NH0.lRaK11OarDsh-BMhxtMtAMq0I5H-OCoDpQTqlPL9uCA';

const supabaseClient = supabase.createClient(
  SUPABASE_URL,
  SUPABASE_KEY
);
</script>

<script>
    function showSchedule() {
        document.getElementById('auth').style.display = 'none';
        document.getElementById('schedule').style.display = 'block';
        loadSchedule();
    }

    function openAddForm() {
        document.getElementById('form').style.display = 'flex';
    }

</script>

<script>
const times = {
    1:"8:00–9:35",2:"9:45–11:25",3:"11:35–13:10",
    4:"13:40–15:15",5:"15:25–17:00",6:"17:10–18:45"
};

function rebuildDay(day){
    const lessons=[...day.querySelectorAll('.urok')];
    const title=day.querySelector('.title_day');
    if(!lessons.length)return;

    const map={};
    lessons.forEach(l=>map[l.dataset.num]=l);
    const nums=lessons.map(l=>+l.dataset.num);
    day.innerHTML='';
    if(title)day.appendChild(title);

    for(let i=Math.min(...nums);i<=Math.max(...nums);i++){
        day.appendChild(map[i]||Object.assign(document.createElement('div'),{className:'empty-urok'}));
    }
}

window.renderLesson=function(lesson){
    const make=(cls)=>{
        const d=document.createElement('div');
        d.className='urok';
        d.dataset.num=lesson.lesson_num;
        d.innerHTML=`
        <span class="${cls}">${lesson.lesson_num}</span>
        <div style="padding-left:10px;text-align:left">
            <p class="name_urok">${lesson.title}</p>
            <p class="time_style">${times[lesson.lesson_num]} <span>${lesson.room}</span></p>
        </div>
        <div class="remove-btn" onclick="this.parentElement.remove();rebuildDay(this.closest('.day'))">✕</div>`;
        return d;
    };

    if(lesson.week!=='even'){
        const d=document.querySelector(`#day1 .day[data-day="${lesson.day}"]`);
        d.appendChild(make('circle')); rebuildDay(d);
    }
    if(lesson.week!=='odd'){
        const d=document.querySelector(`#day2 .day[data-day="${lesson.day}"]`);
        d.appendChild(make('circle2')); rebuildDay(d);
    }
};

async function addLesson() {
    const { data: userData, error: userError } = await supabaseClient.auth.getUser();
    if (userError || !userData.user) {
        alert("Ошибка с авторизацией");
        return;
    }

    const lesson = {
        user_id: userData.user.id,
        day: document.getElementById('daySelect').value,
        week: document.getElementById('weekType').value,
        lesson_num: +document.getElementById('lessonNumber').value,
        title: document.getElementById('name').value,
        teacher: document.getElementById('teacher').value,
        room: document.getElementById('room').value
    };

    if (!lesson.title) { 
        alert("Введите название пары!"); 
        return;
    }

    const { data, error } = await supabaseClient.from('schedule').insert(lesson).select();
    if (error) {
        console.error(error);
        alert("Ошибка при сохранении: " + error.message);
        return;
    }

    renderLesson(data[0]);
    document.getElementById('form').style.display = 'none';
}



async function loadSchedule(){
    const user=(await supabaseClient.auth.getUser()).data.user;
    if(!user)return;

    const {data}=await supabaseClient.from('schedule').select('*').eq('user_id',user.id).order('lesson_num');
    data.forEach(l=>renderLesson(l));
}

async function signUp() {
    alert('signUp вызвалась');
    const emailInput = document.getElementById('email');
    const passwordInput = document.getElementById('password');

    const email = emailInput.value;
    const password = passwordInput.value;

    const { error } = await supabaseClient.auth.signUp({
        email,
        password
    });

    document.getElementById('auth-status').innerText = error
        ? error.message
        : 'Регистрация успешна, теперь войдите';
}


async function signIn() {
    const email = document.getElementById('email').value;
    const password = document.getElementById('password').value;

    const { error } = await supabaseClient.auth.signInWithPassword({
        email,
        password
    });

    document.getElementById('auth-status').innerText = error
        ? error.message
        : 'Вы вошли';

    if (!error) {
        showSchedule();
    }
}

const auth = document.getElementById('auth');
const schedule = document.getElementById('schedule');

(async()=>{
    const {data:{session}}=await supabaseClient.auth.getSession();
    if(session){
        auth.style.display='none';
        schedule.style.display='block';
        loadSchedule();
    }
})();

const checkbox = document.getElementById('toggleCheckbox');
const day1 = document.getElementById('day1');
const day2 = document.getElementById('day2');

/* восстановление выбранной недели */
const savedWeek = localStorage.getItem('week');
if (savedWeek === 'even') {
    checkbox.checked = true;
    day1.style.display = 'none';
    day2.style.display = 'block';
}

/* переключение */
checkbox.addEventListener('change', () => {
    if (checkbox.checked) {
        day1.style.display = 'none';
        day2.style.display = 'block';
        localStorage.setItem('week', 'even');
    } else {
        day1.style.display = 'block';
        day2.style.display = 'none';
        localStorage.setItem('week', 'odd');
    }
});

document.getElementById('logoutBtn').addEventListener('click', async () => {
    const { error } = await supabaseClient.auth.signOut();
    if (error) {
        alert("Ошибка выхода: " + error.message);
        return;
    }

    // Прячем расписание, показываем авторизацию
    schedule.style.display = 'none';
    auth.style.display = 'flex';

    // Можно очистить DOM расписания
    document.querySelectorAll('.urok').forEach(el => el.remove());
});

document.getElementById('logoutBtn').innerText = '⏻';

</script>

</body>
</html>
