<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Расписание</title>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@100..900&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Montserrat', sans-serif;
            text-align: center;
            background-color: #f5f5f5;
            margin: 0;
            padding: 20px;
        }

        .container {
            max-width: 440px;
            margin: auto;
            background: white;
            padding: 20px 20px 0 20px;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0,0,0,.1);
        }

        .title_day {
            margin: 15px 0 15px 25px;
            font-size: 25px;
            font-weight: 700;
            text-align: left;
        }

        .schedule .day {
            padding: 9px;
            margin: 10px 0 30px;
            border-radius: 40px;
            background: linear-gradient(134deg,#ededed 0%,#ffffff 100%);
            box-shadow:
                -26px -26px 50px rgba(255,255,255,0.9),
                -26px 26px 50px rgba(216,216,216,0.2),
                26px -26px 50px rgba(216,216,216,0.2),
                26px 26px 50px rgba(216,216,216,0.9);
        }

        .circle {
            width: 20px;
            height: 20px;
            background: navy;
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 13px;
            font-weight: bold;
        }

        .circle2 {
            width: 20px;
            height: 20px;
            background: #1B5112;
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 13px;
            font-weight: bold;
        }

        .urok {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }

        .empty-urok {
            height: 38px;
            margin-bottom: 10px;
            opacity: .25;
        }

        .time_style {
            color: #757575;
            font-size: 10px;
            margin-top: -2px;
        }

        .name_urok {
            font-size: 12px;
            margin: 0;
            font-weight: 500;
        }

        .remove-btn {
            margin-left: auto;
            cursor: pointer;
            color: #999;
        }

        .add-btn {
            width: 100%;
            margin-bottom: 20px;
            padding: 12px;
            border-radius: 14px;
            border: none;
            background: #0D0125;
            color: #fff;
            font-size: 14px;
            cursor: pointer;
        }

        .form {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,.4);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }

        .form-box {
            background: #fff;
            padding: 20px;
            border-radius: 20px;
            width: 300px;
        }

        .form-box input,
        .form-box select {
            width: 100%;
            margin-bottom: 10px;
            padding: 8px;
            border-radius: 10px;
            border: 1px solid #ddd;
        }

        .auth {
            position: fixed;
            inset: 0;
            background: rgba(245,245,245,.95);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 3000;
        }

        .auth-box {
            width: 320px;
            background: white;
            padding: 25px;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,.15);
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .auth-box button {
            padding: 10px;
            border-radius: 10px;
            border: none;
            background: linear-gradient(#2c2c7a,#0c0c3c);
            color: white;
            font-weight: bold;
            cursor: pointer;
        }

        .auth-box button.secondary {
            background: #eaeaea;
            color: #333;
        }
    </style>
</head>

<body>

<!-- AUTH -->
<div class="auth" id="auth">
    <div class="auth-box">
        <h2>Вход / регистрация</h2>
        <input id="email" type="email" placeholder="Email">
        <input id="password" type="password" placeholder="Пароль">
        <button onclick="signIn()">Войти</button>
        <button class="secondary" onclick="signUp()">Зарегистрироваться</button>
        <p id="auth-status"></p>
    </div>
</div>

<!-- SCHEDULE -->
<div class="container" id="schedule" style="display:none;">
    <button class="add-btn" onclick="openAddForm()">＋ добавить пару</button>

    <div id="day1">
        <div class="day" data-day="monday"><div class="title_day">понедельник</div></div>
        <div class="day" data-day="tuesday"><div class="title_day">вторник</div></div>
        <div class="day" data-day="wednesday"><div class="title_day">среда</div></div>
        <div class="day" data-day="thursday"><div class="title_day">четверг</div></div>
        <div class="day" data-day="friday"><div class="title_day">пятница</div></div>
    </div>

    <div id="day2" style="display:none;">
        <div class="day" data-day="monday"><div class="title_day">понедельник</div></div>
        <div class="day" data-day="tuesday"><div class="title_day">вторник</div></div>
        <div class="day" data-day="wednesday"><div class="title_day">среда</div></div>
        <div class="day" data-day="thursday"><div class="title_day">четверг</div></div>
        <div class="day" data-day="friday"><div class="title_day">пятница</div></div>
    </div>
</div>

<!-- FORM -->
<div class="form" id="form">
    <div class="form-box">
        <select id="daySelect">
            <option value="monday">Понедельник</option>
            <option value="tuesday">Вторник</option>
            <option value="wednesday">Среда</option>
            <option value="thursday">Четверг</option>
            <option value="friday">Пятница</option>
        </select>

        <select id="weekType">
            <option value="odd">Нечётная</option>
            <option value="even">Чётная</option>
            <option value="both">Обе</option>
        </select>

        <select id="lessonNumber">
            <option value="1">1 пара</option>
            <option value="2">2 пара</option>
            <option value="3">3 пара</option>
            <option value="4">4 пара</option>
            <option value="5">5 пара</option>
            <option value="6">6 пара</option>
        </select>

        <input id="name" placeholder="Название">
        <input id="teacher" placeholder="Преподаватель">
        <input id="room" placeholder="Аудитория">

        <button class="add-btn" onclick="addLesson()">Добавить</button>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
const supabase = supabase.createClient(
  'https://zncaxrvlcdkdhmhqrgdw.supabase.co',
  'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpuY2F4cnZsY2RrZGhtaHFyZ2R3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk3MTY4NzQsImV4cCI6MjA4NTI5Mjg3NH0.lRaK11OarDsh-BMhxtMtAMq0I5H-OCoDpQTqlPL9uCA'
);
</script>

<script>
const times = {
    1:"8:00–9:35",2:"9:45–11:25",3:"11:35–13:10",
    4:"13:40–15:15",5:"15:25–17:00",6:"17:10–18:45"
};

function rebuildDay(day){
    const lessons=[...day.querySelectorAll('.urok')];
    const title=day.querySelector('.title_day');
    if(!lessons.length)return;

    const map={};
    lessons.forEach(l=>map[l.dataset.num]=l);
    const nums=lessons.map(l=>+l.dataset.num);
    day.innerHTML='';
    if(title)day.appendChild(title);

    for(let i=Math.min(...nums);i<=Math.max(...nums);i++){
        day.appendChild(map[i]||Object.assign(document.createElement('div'),{className:'empty-urok'}));
    }
}

window.renderLesson=function(lesson){
    const make=(cls)=>{
        const d=document.createElement('div');
        d.className='urok';
        d.dataset.num=lesson.lesson_num;
        d.innerHTML=`
        <span class="${cls}">${lesson.lesson_num}</span>
        <div style="padding-left:10px;text-align:left">
            <p class="name_urok">${lesson.title}</p>
            <p class="time_style">${times[lesson.lesson_num]} <span>${lesson.room}</span></p>
        </div>
        <div class="remove-btn" onclick="this.parentElement.remove();rebuildDay(this.closest('.day'))">✕</div>`;
        return d;
    };

    if(lesson.week!=='even'){
        const d=document.querySelector(`#day1 .day[data-day="${lesson.day}"]`);
        d.appendChild(make('circle')); rebuildDay(d);
    }
    if(lesson.week!=='odd'){
        const d=document.querySelector(`#day2 .day[data-day="${lesson.day}"]`);
        d.appendChild(make('circle2')); rebuildDay(d);
    }
};

async function addLesson(){
    const user=(await supabase.auth.getUser()).data.user;
    if(!user)return;

    const lesson={
        user_id:user.id,
        day:daySelect.value,
        week:weekType.value,
        lesson_num:+lessonNumber.value,
        title:name.value,
        teacher:teacher.value,
        room:room.value
    };

    await supabase.from('schedule').insert(lesson);
    renderLesson(lesson);
    document.getElementById('form').style.display='none';
}

async function loadSchedule(){
    const user=(await supabase.auth.getUser()).data.user;
    if(!user)return;

    const {data}=await supabase.from('schedule').select('*').eq('user_id',user.id).order('lesson_num');
    data.forEach(l=>renderLesson(l));
}

async function signUp(){
    await supabase.auth.signUp({email:email.value,password:password.value});
    auth-status.innerText='Зарегистрировано, войдите';
}

async function signIn(){
    await supabase.auth.signInWithPassword({email:email.value,password:password.value});
    auth.style.display='none';
    schedule.style.display='block';
    loadSchedule();
}

(async()=>{
    const {data:{session}}=await supabase.auth.getSession();
    if(session){
        auth.style.display='none';
        schedule.style.display='block';
        loadSchedule();
    }
})();
</script>

</body>
</html>
